<div class="d-flex justify-content-between">
    <h2 mat-dialog-title>
        Criar um artigo
    </h2>
    <button mat-icon-button matTooltip="Fechar" (click)="closeEditor()">
        <mat-icon>
            close
        </mat-icon>
    </button>
</div>

<mat-dialog-content class="h-75">
    <text-editor *ngIf="!article; else lessonDetail" (articleResult)="getContent($event)"
        (closeResult)="onClose($event)" [article]="data" [stopRequest]="!editing" [closeRequest]="close">
    </text-editor>

    <ng-template #lessonDetail>
        <mat-vertical-stepper [linear]="true">
            <ng-template matStepperIcon="details">
                <mat-icon>
                    panorama_fish_eye
                </mat-icon>
            </ng-template>

            <ng-template matStepperIcon="topic">
                <mat-icon>
                    fact_check
                </mat-icon>
            </ng-template>

            <mat-step label="Detalhes" state="details" [stepControl]="detailFg">
                <div class="d-flex align-items-center justify-content-center">
                    <form [formGroup]="detailFg">
                        <h3>Detalhes</h3>
                        <div class="irrelevant-text text-disabled-1 mb-1">
                            Informe aos seus alunos o assunto que a aula trata. Esta informação
                            funcionará como título da sua aula.
                        </div>
                        <mat-form-field class="mt-1" style="width: 100% !important;" appearance="outline"
                            color="accent">
                            <mat-label>
                                Sumário da aula
                            </mat-label>
                            <input matInput type="text" placeholder="Exercícios de matemática" [formControl]="titleCtl">
                            <mat-error *ngIf="titleCtl.touched && titleCtl.hasError('required')">
                                Campo obrigatório
                            </mat-error>
                            <mat-error *ngIf="titleCtl.touched && titleCtl.errors?.maxlength">
                                Campo obrigatório
                            </mat-error>
                        </mat-form-field>

                        <div class="irrelevant-text text-disabled-1 mb-1">
                            De forma resumida descreva os aspectos mais importantes da sua aula, bem como
                            os seus objectivos, palavras chaves, ou alguma outra mensagem que ache oportuna.
                        </div>
                        <mat-form-field class="mt-1" style="width: 100% !important;" appearance="outline"
                            color="accent">
                            <mat-label>
                                Descrição
                            </mat-label>
                            <textarea matInput cols="10" placeholder="Fale resumidamente sobre a aula"
                                cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="1"
                                cdkAutosizeMaxRows="50" [formControl]="descriptionCtl"> </textarea>
                            <mat-error *ngIf="descriptionCtl.touched && descriptionCtl.hasError('required')">
                                Campo obrigatório
                            </mat-error>
                        </mat-form-field>

                        <div class="irrelevant-text text-disabled-1 mb-1">
                            Escolha a turma onde se destina esta aula. Siga pela selecção
                            da escola e do curso da respectiva turma.
                        </div>

                        <mat-accordion *ngIf="teacherPlacesGrouped" class="mt-1">
                            <mat-expansion-panel *ngFor="let groupedTeacherPlace of teacherPlacesGrouped">
                                <mat-expansion-panel-header>
                                    <mat-panel-title>
                                        <div class="d-flex align-items-center">
                                            <div class="img-profile-xm mr-2">
                                                <img [src]="groupedTeacherPlace.school.profilePhotoPath">
                                            </div>
                                            <span>
                                                {{groupedTeacherPlace.school.shortName}}
                                            </span>
                                        </div>
                                    </mat-panel-title>
                                    <mat-panel-description>
                                        {{groupedTeacherPlace.school.name}}
                                    </mat-panel-description>
                                </mat-expansion-panel-header>
                                <ng-template matExpansionPanelContent>
                                    <mat-accordion>
                                        <mat-expansion-panel
                                            *ngFor="let courseTeacherPlaces of groupedTeacherPlace.courseTeacherPlaces"
                                            class="mat-elevation-z0">
                                            <mat-expansion-panel-header>
                                                <mat-panel-title>
                                                    {{courseTeacherPlaces.course.name}}
                                                </mat-panel-title>
                                            </mat-expansion-panel-header>
                                            <ng-template matExpansionPanelContent>
                                                <mat-selection-list [multiple]="false" [formControl]="teacherPlaceCtl">
                                                    <mat-list-option [value]="teacherPlace"
                                                        *ngFor="let teacherPlace of courseTeacherPlaces.teacherPlaces">
                                                        <div class="d-flex align-items-center">
                                                            <div class="img-profile-xm mr-2"
                                                                *ngIf="teacherPlace.profilePhotoPath; else noImage">
                                                                <img [src]="teacherPlace.profilePhotoPath">
                                                            </div>
                                                            <span class="irrelevant-text-sm">
                                                                {{teacherPlace.name}}
                                                            </span>
                                                        </div>
                                                    </mat-list-option>
                                                </mat-selection-list>
                                            </ng-template>
                                        </mat-expansion-panel>
                                    </mat-accordion>
                                </ng-template>
                            </mat-expansion-panel>
                        </mat-accordion>


                        <ng-container *ngIf="teacherPlaceCtl.value[0] && teacherPlaceCtl.value[0].opened">
                            <div class="irrelevant-text text-disabled-1 mt-5">
                                {{
                                isPublic ?
                                'Aulas publicas podem ser assistidas por todos, inclusive quem não estiver
                                matriculado na turma
                                onde a aula será publicada.'
                                :
                                'Aulas privadas podem ser assistidas apenas pelos estudantes matriculados na turma
                                onde a aula fôr
                                publicada. Todas as aulas de uma turma fechada são privadas.'
                                }}
                            </div>
                            <mat-slide-toggle [(ngModel)]="isPublic" [ngModelOptions]="{standalone: true}">
                                {{isPublic ? 'Aula pública' : 'Aula privada'}}
                            </mat-slide-toggle>
                        </ng-container>

                        <div class="irrelevant-text text-disabled-1 mb-1 mt-5">
                            Escolha uma imagem como miniatura
                        </div>
                        <div class="d-flex justify-content-start">
                            <div class="w-25 p-relative">
                                <div [style]="{'height':'6rem'}"
                                    class="d-flex justify-content-center align-items-center border">
                                    <mat-icon *ngIf="!imgUrl; else preview"> image </mat-icon>

                                    <ng-template #preview>
                                        <div class="thumbnail-preview">
                                            <img [src]="imgUrl" alt="">
                                        </div>
                                    </ng-template>
                                </div>

                                <input *ngIf="!imgUrl" type="file" #fileInput id="uploadFile"
                                    (change)="uploadImageEvt($event)" name="uploadFile" accept="img/*" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="mt-4 d-flex justify-content-center align-items-center flex-column">
                    <button matStepperNext mat-flat-button color="warn" (click)="onVideoDetailComplete()"
                        class="w-25 mb-4">
                        Seguinte
                    </button>
                    <button matStepperPrevious mat-stroked-button (click)="editing = true" class="w-25">
                        Retroceder
                    </button>
                </div>
            </mat-step>

            <mat-step label="Tópico" state="topic" [stepControl]="disciplineTopicCtl">
                <div class="d-flex align-items-center justify-content-center">
                    <form [formGroup]="disciplineTopicCtl">
                        <ng-container *ngIf="disciplineTopics$ | async as disciplineTopics; else loadingItems">
                            <mat-error *ngIf="disciplineTopicCtl.touched && disciplineTopicCtl.hasError('required')">
                                Deve escolher um tópico para a nova aula
                            </mat-error>

                            <ng-container *ngIf="disciplineTopics?.length > 0">
                                <div class="irrelevant-text text-disabled-1 mb-1">
                                    Seleccione o tópico da aula.
                                    Caso o tópico seja novo, pode criar abaixo.
                                </div>

                                <mat-selection-list [multiple]="false" [formControl]="disciplineTopicCtl" class="mt-1">
                                    <mat-list-option *ngFor="let disciplineTopic of disciplineTopics"
                                        [value]="disciplineTopic">
                                        {{disciplineTopic.name}}
                                    </mat-list-option>
                                </mat-selection-list>
                            </ng-container>

                            <div class="irrelevant-text text-disabled-1 mb-1 mt-4">
                                Os tópicos servem para agrupar um conjunto de aulas
                                que abordam um mesmo tema. É uma óptima forma de ter as aulas
                                organizadas sequencialmente.
                            </div>
                            <mat-form-field appearance="outline" class="mt-1">
                                <mat-label>
                                    Criar um novo tópico
                                </mat-label>
                                <input [formControl]="disciplineTopicCtl" placeholder="Números Reais"
                                    [matAutocomplete]="auto" matInput>
                            </mat-form-field>
                            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
                                <mat-option *ngFor="let disciplineTopic of disciplineTopicsFiltered$ | async "
                                    [value]="disciplineTopic">
                                    {{disciplineTopic.name}}
                                </mat-option>
                            </mat-autocomplete>
                        </ng-container>
                    </form>
                </div>

                <ng-container>
                    <div class="mt-4 d-flex justify-content-center align-items-center flex-column">
                        <button mat-flat-button mat-flat-button color="accent" class="w-25 mb-4"
                            (click)="onLessonCreate()" [disabled]="submited">
                            Criar
                        </button>
                        <button matStepperPrevious mat-stroked-button class="w-25">
                            Voltar
                        </button>
                    </div>
                </ng-container>
            </mat-step>
        </mat-vertical-stepper>
    </ng-template>
</mat-dialog-content>

<mat-dialog-actions>
    <div class="d-flex justify-content-end w-100">
        <button mat-flat-button (click)="stopEditing()" [hidden]="!editing" color="primary">
            Concluido
        </button>
    </div>
</mat-dialog-actions>

<ng-template #noImage>
    <div class="img-profile-xxm-none">
        <div></div>
    </div>
</ng-template>

<ng-template #loadingItems>
    <div class="w-50 h-50 d-flex justify-content-center">
        <mat-progress-spinner mode="indeterminate" color="primary"></mat-progress-spinner>
    </div>
</ng-template>